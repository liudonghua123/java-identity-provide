<?xml version="1.0" encoding="UTF-8"?>
<schema xmlns="http://www.w3.org/2001/XMLSchema" targetNamespace="urn:mace:shibboleth:2.0:metadata"
    xmlns:shibmd="urn:mace:shibboleth:2.0:metadata" xmlns:security="urn:mace:shibboleth:2.0:security"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata"
    xmlns:alg="urn:oasis:names:tc:SAML:metadata:algsupport"
    elementFormDefault="qualified">

    <annotation>
        <documentation>Schema describing metadata providers and filters.</documentation>
    </annotation>

    <import namespace="urn:oasis:names:tc:SAML:2.0:assertion"
        schemaLocation="http://docs.oasis-open.org/security/saml/v2.0/saml-schema-assertion-2.0.xsd"/>
    <import namespace="urn:oasis:names:tc:SAML:2.0:metadata"
        schemaLocation="http://docs.oasis-open.org/security/saml/v2.0/saml-schema-metadata-2.0.xsd"/>
    <import namespace="urn:oasis:names:tc:SAML:metadata:algsupport"
        schemaLocation="http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-metadata-algsupport-v1.0.xsd"/>
    <import namespace="urn:mace:shibboleth:2.0:security"
        schemaLocation="http://shibboleth.net/schema/idp/shibboleth-security.xsd"/>

    <element name="MetadataProvider" type="shibmd:MetadataProviderType">
        <annotation>
            <documentation>Defines a provider of SAML 2 metadata information.</documentation>
        </annotation>
    </element>
    <complexType name="ChainingMetadataProvider">
        <annotation>
            <documentation>
                A metadata provider that composes other metadata providers. During a lookup operation member providers
                are searched in the order they listed in this providers configuration until one provides a response to
                the lookup. That response is then returned, no subsequent member providers are inspected.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataProviderType">
                <sequence>
                    <element ref="shibmd:MetadataProvider" minOccurs="0" maxOccurs="unbounded">
                        <annotation>
                            <documentation>
                                A member metadata provider that will be searched for information.
                            </documentation>
                        </annotation>
                    </element>
                </sequence>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="ResourceBackedMetadataProvider">
        <annotation>
            <documentation>A metadata provider that reads metadata from a Resource.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:ReloadingMetadataProviderType">
                <attribute name="resourceRef" type="shibmd:string">
                    <annotation>
                        <documentation>the name of a bean with the (Spring) resource to use</documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="InlineMetadataProvider">
        <annotation>
            <documentation>A metadata provider that allows SAML 2 metadata to be specified inline.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataProviderType">
                <choice>
                    <element ref="md:EntitiesDescriptor">
                        <annotation>
                            <documentation>A SAML 2 metadata EntitiesDescriptor declaration.</documentation>
                        </annotation>
                    </element>
                    <element ref="md:EntityDescriptor">
                        <annotation>
                            <documentation>A SAML 2 metadata EntitiesDescriptor declaration.</documentation>
                        </annotation>
                    </element>
                </choice>
                <attribute name="indexesRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            ID of a Set of MetadataIndex instances used to support resolution of metadata based on
                            criteria other than an entityID.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="resolveViaPredicatesOnly" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Flag indicating whether resolution may be performed solely by applying predicates to the
                            entire metadata collection. Defaults to false.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="FileBackedHTTPMetadataProvider">
        <annotation>
            <documentation>
                A metadata provider that periodically pulls metadata from a given URL. If the metadata is valid it is
                stored to disk. If the provided URL can not be reached or the metadata retrieved is invalid this
                provider will fall back to its on-disk copy.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:ReloadingMetadataProviderType">
                <sequence>
                    <element name="TLSTrustEngine"  minOccurs="0" maxOccurs="1">
                        <annotation>
                            <documentation>
                                TrustEngine used to evaluate HTTPS server TLS certificates.
                            </documentation>
                        </annotation>
                        <complexType>
                            <sequence>
                                <element ref="security:TrustEngine" minOccurs="1" maxOccurs="1" />
                            </sequence>
                        </complexType>
                    </element>
                </sequence>
                <attribute name="backingFile" type="shibmd:string" use="required">
                    <annotation>
                        <documentation>
                            The path to the temporary file used to store valid metadata on-disk.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="initializeFromBackupFile" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Flag indicating whether initialization should first attempt to load metadata from backup file.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="backupFileInitNextRefreshDelay" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Duration in milliseconds after which to schedule next refresh when initialized from backup file. 
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="httpClientRef" type="shibmd:string">
                    <annotation>
                        <documentation>
	                        The reference to an externally defined Spring bean which specifies an
	                        org.apache.http.client.HttpClient object.
	                        
	                        This attribute conflicts with all other settings except metadata URL
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="httpClientSecurityParametersRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A reference to an externally defined Spring bean which specifies an
                            org.opensaml.security.httpclient.HttpClientSecurityParameters object.
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="metadataURL" type="shibmd:string" use="required">
                    <annotation>
                        <documentation>The URL from which to retrieve the metadata.</documentation>
                    </annotation>
                </attribute>
                <attribute name="disregardTLSCertificate" type="shibmd:string">
                    <annotation>
                        <documentation>Server certificate will be ignored when using an HTTPS source.</documentation>
                    </annotation>
                </attribute>
                <attribute name="connectionTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum length of time to wait for the remote server to response.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="connectionRequestTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum length of time to wait for a connection to be returned from the connection manager.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="socketTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum period inactivity between two consecutive data packets.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyHost" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Hostname of the HTTP proxy through which connections will be made.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyPort" type="shibmd:string">
                    <annotation>
                        <documentation>Port of the HTTP proxy through which connections will be made.</documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyUser" type="shibmd:string">
                    <annotation>
                        <documentation>User name used with the HTTP proxy through which connections will be made.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyPassword" type="string">
                    <annotation>
                        <documentation>Password used with the HTTP proxy through which connections will be made.
                        </documentation>
                    </annotation>
                </attribute>
                <!-- Need to deal with socket factory -->
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="FilesystemMetadataProvider">
        <annotation>
            <documentation>A metadata provider that reads SAML2 metadata from the filesystem.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:ReloadingMetadataProviderType">
                <attribute name="metadataFile" type="shibmd:string" use="required">
                    <annotation>
                        <documentation>The path to the metadata file.</documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="DynamicHTTPMetadataProvider">
        <annotation>
            <documentation>
                A metadata provider that dynamically fetches metadata from an HTTP server.
                
                Four strategies are supported for constructing the metadata request URL based on the requested entityID.
                Only one strategy may be configured for any given instance of a metadata provider.
                
                Three correspond directly to the 3 child element types of the this type: Template, Regex and MetadataQueryProtocol.
                See those individual elements for details.
                
                The fourth, used when none of the above 3 child elements is present, is to treat an HTTP or HTTPS entityID as the
                metadata request URL.  This corresponds to the "well-known location" mechanism, as defined in the SAML 2.0
                Metadata specification, section 4.1.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:AbstractDynamicHTTPMetadataProviderType">
                <choice minOccurs="0" maxOccurs="1">
                    <element name="Template">
                        <annotation>
                            <documentation>
                                Constructs the metadata request URL by means of a simple transform on the
                                template specified by this element. The entityID is substituted into the
                                template parameter "${entityID}". If the element contains an encoded attribute
                                set to "false", the value will be replaced directly, otherwise it will be URL-encoded.
                            </documentation>
                        </annotation>
                        <complexType>
                            <simpleContent>
                                <extension base="string">
                                    <attribute name="velocityEngine" type="shibmd:string">
                                        <annotation>
                                            <documentation>
                                                Name of the Velocity Engine defined within the application.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                    <attribute name="encodingStyle" type="shibmd:string">
                                        <annotation>
                                            <documentation>
                                                Enum value indicating whether and how the entityID should be encoded into the 
                                                URL. Allowed values are: 1) none 2) form 3) path 4) fragment.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                    <attribute name="transformRef" type="shibmd:string">
                                        <annotation>
                                            <documentation>
                                                Reference to an optional transform function for the entity ID.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                </extension>
                            </simpleContent>
                        </complexType>
                    </element>
                    <element name="Regex">
                        <annotation>
                            <documentation>
                                Constructs the metadata request URL by means of a complex transform containing a match attribute containing a 
                                regular expression against which the entityID value is applied, and whose element content contains a 
                                replacement expression to run based on the results of the match. 
                                Only numeric/positional group references (e.g. $1) are supported.
                            </documentation>
                        </annotation>
                        <complexType>
                            <simpleContent>
                                <extension base="string">
                                    <attribute name="match" type="shibmd:string" use="required">
                                        <annotation>
                                            <documentation>
                                                Regular expression against which the entityID is evaluated.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                </extension>
                            </simpleContent>
                        </complexType>
                    </element>
                    <element name="MetadataQueryProtocol">
                        <annotation>
                            <documentation>
                                Constructs a metadata request URL based on the requirements of the Metadata Query Protocol.
                                The content of this element will be used as the "Base URL" as defined in that specification.
                                
                                Base protocol: https://datatracker.ietf.org/doc/draft-young-md-query/
                                
                                SAML profile: http://datatracker.ietf.org/doc/draft-young-md-query-saml/
                            </documentation>
                        </annotation>
                        <complexType>
                            <simpleContent>
                                <extension base="string">
                                    <attribute name="transformRef" type="shibmd:string">
                                        <annotation>
                                            <documentation>
                                                Reference to an optional transform function for the entity ID.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                    <attribute name="secondaryURLBuildersRef" type="shibmd:string">
                                        <annotation>
                                            <documentation>
                                                Reference to a list of secondary URL builders for non-entityID-based lookups.
                                                The list should contain instances of the interface 
                                                org.opensaml.saml.metadata.resolver.impl.MetadataQueryProtocolRequestURLBuilder.MetadataQueryProtocolURLBuilder.
                                            </documentation>
                                        </annotation>
                                    </attribute>
                                </extension>
                            </simpleContent>
                        </complexType>
                    </element>
                </choice>
            </extension>
        </complexContent>
    </complexType>
                
    <complexType name="AbstractDynamicHTTPMetadataProviderType" abstract="true">
        <annotation>
            <documentation>A metadata provider that dynamically fetches metadata from an HTTP server.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:DynamicMetadataProviderType"> 
                <sequence>
                    <element name="TLSTrustEngine"  minOccurs="0" maxOccurs="1">
                        <annotation>
                            <documentation>
                                TrustEngine used to evaluate HTTPS server TLS certificates.
                            </documentation>
                        </annotation>
                        <complexType>
                            <sequence>
                                <element ref="security:TrustEngine" minOccurs="1" maxOccurs="1" />
                            </sequence>
                        </complexType>
                    </element>
                </sequence>
                <attribute name="httpClientRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A reference to an externally defined Spring bean which specifies an
                            org.apache.http.client.HttpClient object.
                            
                            This attribute conflicts with and overrides the other HttpClient-related properties: 
                            disregardTLSCertificate, proxyHost, proxyPort, proxyUser, proxyPassword.
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="httpClientSecurityParametersRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A reference to an externally defined Spring bean which specifies an
                            org.opensaml.security.httpclient.HttpClientSecurityParameters object.
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="supportedContentTypes" type="shibmd:MIMETypeListType">
                    <annotation>
                        <documentation>
                            MIME types which are supported by this provider when requesting metadata from the
                            HTTP server. The HTTP response Content-Type will also be validated against this list.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="disregardTLSCertificate" type="shibmd:string">
                    <annotation>
                        <documentation>Server certificate will be ignored when using an HTTPS source.</documentation>
                    </annotation>
                </attribute>
                <attribute name="connectionTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum length of time to wait for the remote server to response.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="connectionRequestTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum length of time to wait for a connection to be returned from the connection manager.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="socketTimeout" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum period inactivity between two consecutive data packets.
                            Timeout is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="maxConnectionsTotal" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Max total simultaneous connections allowed by the pooling connection manager.
                            Defaults to: 100.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="maxConnectionsPerRoute" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Max simultaneous connections per route allowed by the pooling connection manager.
                            Defaults to: 100.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyHost" type="shibmd:string">
                    <annotation>
                        <documentation>Hostname of the HTTP proxy through which connections will be made.</documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyPort" type="shibmd:string">
                    <annotation>
                        <documentation>Port of the HTTP proxy through which connections will be made.</documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyUser" type="shibmd:string">
                    <annotation>
                        <documentation>User name for the HTTP proxy through which connections will be made.</documentation>
                    </annotation>
                </attribute>
                <attribute name="proxyPassword" type="string">
                    <annotation>
                        <documentation>Password for the HTTP proxy through which connections will be made.</documentation>
                    </annotation>
                </attribute>
                <!-- Need to deal with socket factory -->
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="LocalDynamicMetadataProvider">
        <annotation>
            <documentation>A metadata provider that dynamically fetches metadata from 
            a local source provided by an instance of XMLObjectLoadSaveManager.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:DynamicMetadataProviderType"> 
                <attribute name="sourceManagerRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Bean reference to the XMLObjectLoadSaveManager which serves as the local source of metadata.
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="sourceKeyGeneratorRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Bean reference to the function which generates the source key from criteria at runtime.
                       </documentation>
                    </annotation>
                </attribute>
                <attribute name="sourceDirectory" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Convenience mechanism for wiring a FilesystemLoadSaveManager loading from the specified
                            source directory in the local filesystem. This attribute will be ignored if 
                            'sourceManagerRef' is also specified.

                            The manager will be configured to check and only return data for an entity if unmodified 
                            since the last request, i.e. with the manager parameter conditionalLoad=true.
                            
                            The source key generator function, if otherwise unspecified, will default to generating
                            the SHA-1 digest (encoded as lower-case hexadecimal) of the input criteria entityID, 
                            suffixed with ".xml". Example:  The metadata for the entity with entityID
                            "urn:test:foobar" will be resolved from the source directory with filename
                            "d278c9975472a6b4827b1a8723192b4e99aa969c.xml".
                       </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>
    
    <simpleType name="MIMETypeListType">
        <list itemType="string"/>
    </simpleType>

    <complexType name="DynamicMetadataProviderType" abstract="true">
        <annotation>
            <documentation>A metadata provider that fetches metadata dynamically on demand.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataProviderType">
                <attribute name="parserPoolRef" type="shibmd:string">
                    <annotation>
                        <documentation>ID of the parser pool used to parse incoming metadata.</documentation>
                    </annotation>
                </attribute>
                <attribute name="indexesRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            ID of a Set of MetadataIndex instances used to support resolution of metadata based on
                            criteria other than an entityID.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="taskTimerRef" type="shibmd:string">
                    <annotation>
                        <documentation>ID of the task timer used to schedule background refresh jobs.</documentation>
                    </annotation>
                </attribute>
                <attribute name="refreshDelayFactor" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Factor applied to metadata's expiration time in order to determine next refresh
                            time. Must be between 0.0 and 1.0, exclusive.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="minCacheDuration" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The minimum duration for which metadata will be cached before it is refreshed.
                            This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="maxCacheDuration" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum duration for which metadata will be cached before it is refreshed.
                            This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="negativeLookupCacheDuration" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The duration for which a negative lookup result will be cached. 
                            While the negative lookup cache for an entity's metadata is in effect, no additional lookups will be attempted.
                            This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="maxIdleEntityData" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum duration for which metadata will be allowed to be idle (no requests for it) 
                            before it is removed from the cache. This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="removeIdleEntityData" type="shibmd:string">
                    <annotation>
                        <documentation>A boolean flag indicating whether idle metadata should be removed.</documentation>
                    </annotation>
                </attribute>
                <attribute name="expirationWarningThreshold" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Impending expiration warning threshold for metadata refresh.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="cleanupTaskInterval" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The interval at which the internal cleanup task should run.  This task performs
                            background maintenance tasks, such as the removal of expired and idle metadata.
                            This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="persistentCacheManagerRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The manager for the persistent cache store for resolved metadata.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="persistentCacheManagerDirectory" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The directory used for an internally-constructed filesystem-based persistent cache.
                            This is a convenience parameter to avoid specifying a full bean via persistentCacheManagerRef.
                            This option will be ignored if persistentCacheManagerRef is specified.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="persistentCacheKeyGeneratorRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Function for generating the string key used with the cache manager.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="initializeFromPersistentCacheInBackground" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating whether should initialize from the persistent cache in the background.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="backgroundInitializationFromCacheDelay" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The delay after which to schedule the background initialization from the persistent cache. 
                            This value is expressed in ISO8601 duration notation.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="initializationFromCachePredicateRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Predicate which determines whether a given entity should be loaded from the
                            persistent cache at resolver initialization time.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="ReloadingMetadataProviderType" abstract="true">
        <annotation>
            <documentation>A metadata provider that periodically reloads a cached metadata document.</documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataProviderType">
                <attribute name="parserPoolRef" type="shibmd:string">
                    <annotation>
                        <documentation>ID of the parser pool used to parse incoming metadata.</documentation>
                    </annotation>
                </attribute>
                <attribute name="indexesRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            ID of a Set of MetadataIndex instances used to support resolution of metadata based on
                            criteria other than an entityID.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="resolveViaPredicatesOnly" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Flag indicating whether resolution may be performed solely by applying predicates to the
                            entire metadata collection. Defaults to false.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="taskTimerRef" type="shibmd:string">
                    <annotation>
                        <documentation>ID of the task timer used to schedule background refresh jobs.</documentation>
                    </annotation>
                </attribute>
                <attribute name="refreshDelayFactor" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Factor applied to metadata's expiration time in order to determine next refresh
                            time. Must be between 0.0 and 1.0, exclusive.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="maxRefreshDelay" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Maximum amount time, from the previous, before a metadata refresh cycle runs.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="minRefreshDelay" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Minimum amount of time, from the previous, before a metadata refresh cycle runs.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="expirationWarningThreshold" type="shibmd:string">
                    <annotation>
                        <documentation>
                            Impending expiration warning threshold for metadata refresh.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="MetadataProviderType" abstract="true">
        <choice minOccurs="0" maxOccurs="unbounded">
            <element ref="shibmd:MetadataFilter">
                <annotation>
                    <documentation>
                        A filter to be applied to metadata after it has been parsed and validated.
                    </documentation>
                </annotation>
            </element>
        </choice>
        <attribute name="id" type="ID" use="required">
            <annotation>
                <documentation>A unique identifier that may be used to identify a particular provider.</documentation>
            </annotation>
        </attribute>
        <attribute name="requireValidMetadata" type="shibmd:string">
            <annotation>
                <documentation>
                    A boolean flag indicating whether the metadata retrieved must be valid. At a minimum, metadata is
                    valid only if the date expressed in entity's validUntil attribute has not passed. Specific
                    implementations may add additional constraints.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="failFastInitialization" type="shibmd:string">
            <annotation>
                <documentation>
                    Determines if the metadata provider "fails fast" during initialization. This means that
                    if there is a problem initializing the metadata provider it will stop the IdP from starting.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="satisfyAnyPredicates" type="shibmd:string">
            <annotation>
                <documentation>
                    Flag which determines whether predicates used in filtering are connected by 
                    a logical 'OR' (true) or by logical 'AND' (false). Defaults to false.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="criterionPredicateRegistryRef" type="shibmd:string">
            <annotation>
                <documentation>
                    Reference to bean for the predicate registry used in resolving predicates from criteria.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="useDefaultPredicateRegistry" type="shibmd:string">
            <annotation>
                <documentation>
                    Flag which determines whether the default predicate registry will be used if one is not supplied explicitly.
                    Defaults to true.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="sortKey" type="shibmd:string">
            <annotation>
                <documentation>
                    This Integer value determines the processing order for top level Metadata providers.
                    A top level metadata provider is either the topmost element in a file or the single
                    metadata provider inside a RelyinPartyGroup.  The metadata processing consults the
                    provider tree with the lowest sortKey first. 
                </documentation>
            </annotation>
        
        </attribute> 
    </complexType>

    <element name="MetadataFilter" type="shibmd:MetadataFilterType">
        <annotation>
            <documentation>
                Defines a filter that is applied to SAML2 metadata after it has been parsed and validated.
                Filters may be used to remove unnecessary information or perform other transformative logic.
            </documentation>
        </annotation>
    </element>

    <complexType name="RequiredValidUntil">
        <annotation>
            <documentation>
                A filter that requires the presence of a validUntil attribute on the root of the metadata and,
                optionally, requires that that date not be more than some amount of time in the future.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <attribute name="maxValidityInterval" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The maximum amount of time, from now, which the validUntil attribute may be set.
                            This provides an upper limit to the lifetime of any metadata.

                            Interval is expressed in  ISO8601 duration notation. Default is P14D (14 days)
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="SchemaValidation">
        <annotation>
            <documentation>
                A filter that performs XML schema validation on incoming metadata documents being processed.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <attribute name="schemaBuilderRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The reference to an externally defined Spring bean which specifies a
                            org.opensaml.saml.common.xml.SAMLSchemaBuilder object.
                            
                            In the absence of this object the bean called shibboleth.SchemaBuilder is used.
                       </documentation>
                    </annotation>
                </attribute>            </extension>
        </complexContent>
    </complexType>

    <complexType name="SignatureValidation">
        <annotation>
            <documentation>
                A filter that checks, and optionally requires, the signature on the top level of the incoming metadata.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <choice minOccurs="0" maxOccurs="1"> 
                    <element name="PublicKey" type="shibmd:string" minOccurs="0" maxOccurs="1">
                        <annotation>
                            <documentation>The PEM of the public key used to sign the metadata.</documentation>
                        </annotation>
                    </element>
                    <element ref="security:TrustEngine">
                        <annotation>
                            <documentation>Trust engines used by a filter.</documentation>
                        </annotation>
                    </element>
                </choice>
                <attribute name="trustEngineRef" type="shibmd:string">
                    <annotation>
                        <documentation>The ID of the trust engine used to validate the signature.</documentation>
                    </annotation>
                </attribute>
                <attribute name="requireSignedRoot" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating whether a signature is required on the incoming metadata's root element.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="alwaysVerifyTrustedSource" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating whether the root signature of a trusted source should always be verified.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="certificateFile" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The location of a file containing a certificate with the public key to test against.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="defaultCriteriaRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The ID of the optional set of static criteria supplied to the trust engine.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="signaturePrevalidatorRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The ID of the optional signature prevalidator used to validate some
                            non-cryptographic aspects of the signature, prior to cryptographic verification.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="dynamicTrustedNamesStrategyRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The ID of the optional strategy used to build at runtime the set of dynamic
                            PKIX trusted names supplied to the trust engine via the passed criteria set.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="EntityRole">
        <annotation>
            <documentation>
                A filter that removes roles from an EntityDescriptor that do not appear in the filter's RetainedRoles.
                Optionally an EntityDescriptor may be completely removed if it does not contain at least one role after
                the filter. EntitiesDescriptors may be removed if they do not contain at least one entity or entities
                descriptor after the filtering.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <sequence>
                    <element name="RetainedRole" type="QName" minOccurs="0" maxOccurs="unbounded">
                        <annotation>
                            <documentation>
                                The effective QName for the roles which should not NOT be removed by the filter. The
                                effective name is the element name for those roles defined within the SAML metadata
                                specification and the schema type name for those that are not.
                            </documentation>
                        </annotation>
                    </element>
                </sequence>
                <attribute name="removeRolelessEntityDescriptors" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating that entity descriptors that do not contain at least one role,
                            after filtering, should be removed.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="removeEmptyEntitiesDescriptors" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating that entities descriptors that do not contain at least one entity
                            or entities descriptor, after filtering, should be removed.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="EntityRoleWhiteList">
        <annotation>
            <documentation>
                DEPRECATED name for EntityRole filter.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:EntityRole" />
        </complexContent>
    </complexType>
    
    <complexType name="EntityAttributes">
        <annotation>
            <documentation>
                A filter that adds SAML EntityAttribute extension content to metadata in order to drive software
                behavior based on them. Sequences of Attribute elements are supplied, and when an Entity or
                ConditionRef is encountered, the preceding Attributes are applied to the corresponding entities.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <sequence>
                    <choice minOccurs="0">
                        <element name="AttributeFilterRef" type="shibmd:string">
                            <annotation>
                                <documentation>
                                    The ID of a Spring bean to inject as a condition Predicate to determine whether
                                    pre-existing EntityAttributes child Attributes should be retained.
                                </documentation>
                            </annotation>
                        </element>
                        <element name="AttributeFilterScript" type="shibmd:ScriptType" minOccurs="0">
                            <annotation>
                                <documentation>
                                    A script implementing Predicate&lt;Attribute&gt; to determine whether
                                    pre-existing EntityAttributes child Attributes should be retained.
                                </documentation>
                            </annotation>
                        </element>
                    </choice>
                    <choice minOccurs="0" maxOccurs="unbounded">
                        <element ref="saml:Attribute">
                            <annotation>
                                <documentation>
                                    An Attribute to add to an EntityAttributes extension. 
                                </documentation>
                            </annotation>
                        </element>
                        <element name="Entity" type="shibmd:string">
                            <annotation>
                                <documentation>
                                    An entityID to identify an EntityDescriptor to add all the preceding
                                    Attribute elements to. 
                                </documentation>
                            </annotation>
                        </element>
                        <element name="ConditionRef" type="shibmd:string">
                            <annotation>
                                <documentation>
                                    The ID of a Spring bean to inject as a condition Predicate to identify one
                                    or more EntityDescriptors to add all the preceding Attribute elements to. 
                                </documentation>
                            </annotation>
                        </element>
                        <element name="ConditionScript" type="shibmd:ScriptType">
                            <annotation>
                                <documentation>
                                    A script implementing Predicate&lt;EntityDescriptor&gt; to identify one
                                    or more EntityDescriptors to add all the preceding Attribute elements to. 
                                </documentation>
                            </annotation>
                        </element>
                    </choice>
                </sequence>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="NameIDFormat">
        <annotation>
            <documentation>
                A filter that adds NameIDFormat content to metadata in order to drive software
                behavior based on them. Sequences of NameIDFormat elements are supplied, and when an Entity or
                ConditionRef is encountered, the preceding formats are applied to the supporting roles of the
                corresponding entities.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <choice minOccurs="0" maxOccurs="unbounded">
                    <element name="Format" type="shibmd:string">
                        <annotation>
                            <documentation>
                                A format to add. 
                            </documentation>
                        </annotation>
                    </element>
                    <element name="Entity" type="shibmd:string">
                        <annotation>
                            <documentation>
                                An entityID to identify an EntityDescriptor to add all the preceding
                                formats to.
                            </documentation>
                        </annotation>
                    </element>
                    <element name="ConditionRef" type="shibmd:string">
                        <annotation>
                            <documentation>
                                The ID of a Spring bean to inject as a condition Predicate to identify one
                                or more EntityDescriptors to add all the preceding NameIDFormat elements to. 
                            </documentation>
                        </annotation>
                    </element>
                    <element name="ConditionScript" type="shibmd:ScriptType">
                        <annotation>
                            <documentation>
                                A script implementing Predicate&lt;EntityDescriptor&gt; to identify one
                                or more EntityDescriptors to add all the preceding Attribute elements to. 
                            </documentation>
                        </annotation>
                    </element>
                </choice>
                <attribute name="removeExistingFormats" type="boolean">
                    <annotation>
                        <documentation>
                            Whether to remove any existing formats when adding new ones (default is false).
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="Predicate">
        <annotation>
            <documentation>
                A filter that whitelists or blacklists EntityDescriptors based on the result of applying a Predicate
                to each EntityDescriptor in the source. Limited syntax is provided for common cases, along with the
                ability to reference a Spring bean as the Predicate. EntitiesDescriptors may be removed if they do not
                contain at least one entity or entities descriptor after the filtering.
                
                All predicates implicitly or explicitly combined are a conjunction (OR). For alternative strategies,
                use conditionRef alone. 
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <choice minOccurs="0" maxOccurs="unbounded">
                    <element name="Entity" type="shibmd:string">
                        <annotation>
                            <documentation>
                                An entityID to use in a predicate that matches on entityID. 
                            </documentation>
                        </annotation>
                    </element>
                    <element name="Group" type="shibmd:string">
                        <annotation>
                            <documentation>
                                A name to use in a predicate that matches on EntitiesDescriptor group/containment. 
                            </documentation>
                        </annotation>
                    </element>
                    <element name="Tag">
                        <annotation>
                            <documentation>
                                A rule to use in a predicate that matches on EntityAttributes extensions.
                            </documentation>
                        </annotation>
                        <complexType>
                            <sequence>
                                <element name="Value" type="shibmd:string" maxOccurs="unbounded"/>
                            </sequence>
                            <attribute name="name" type="shibmd:string" use="required" />
                            <attribute name="nameFormat" type="shibmd:string"/>
                        </complexType>
                    </element>
                    <element name="MappedTag">
                        <annotation>
                            <documentation>
                                A rule to use in a predicate that matches on mapped EntityAttributes extensions.
                            </documentation>
                        </annotation>
                        <complexType>
                            <sequence>
                                <element name="Value" type="shibmd:string" maxOccurs="unbounded"/>
                            </sequence>
                            <attribute name="name" type="shibmd:string" use="required" />
                        </complexType>
                    </element>
                    <element name="ConditionScript" type="shibmd:ScriptType">
                        <annotation>
                            <documentation>
                                A script implementing Predicate&lt;EntityDescriptor&gt; to identify one
                                or more EntityDescriptors to which to apply the filter.
                            </documentation>
                        </annotation>
                    </element>
                </choice>
                <attribute name="direction" type="shibmd:string" use="required">
                    <annotation>
                        <documentation>
                            One of the values "include" or "exclude" indicating whether to whitelist or blacklist
                            entities that satisfy the Predicate used.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="conditionRef" type="shibmd:string">
                    <annotation>
                        <documentation>
                            The ID of a Spring bean to inject as a condition Predicate.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="trim" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating whether a Predicate based on EntityAttribute extensions
                            should trim values before comparison. Defaults to false.
                        </documentation>
                    </annotation>
                </attribute>
                <attribute name="removeEmptyEntitiesDescriptors" type="shibmd:string">
                    <annotation>
                        <documentation>
                            A boolean flag indicating that entities descriptors that do not contain at least one entity
                            or entities descriptor, after filtering, should be removed.
                        </documentation>
                    </annotation>
                </attribute>
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="Algorithm">
        <annotation>
            <documentation>
                A filter that adds SAML Algorithm Support extension content to metadata in order to drive software
                behavior based on them. Sequences of algorithm elements are supplied, and when an Entity or
                ConditionRef is encountered, the preceding elements are applied to the corresponding entities.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <sequence>
                    <choice minOccurs="0" maxOccurs="unbounded">
                        <element ref="alg:DigestMethod" />
                        <element ref="alg:SigningMethod" />
                        <element ref="md:EncryptionMethod" />
                        <element name="Entity" type="shibmd:string">
                            <annotation>
                                <documentation>
                                    An entityID to identify an EntityDescriptor to add all the preceding
                                    extension elements to. 
                                </documentation>
                            </annotation>
                        </element>
                        <element name="ConditionRef" type="shibmd:string">
                            <annotation>
                                <documentation>
                                    The ID of a Spring bean to inject as a condition Predicate to identify one
                                    or more EntityDescriptors to add all the preceding extension elements to. 
                                </documentation>
                            </annotation>
                        </element>
                        <element name="ConditionScript" type="shibmd:ScriptType">
                            <annotation>
                                <documentation>
                                    A script implementing Predicate&lt;EntityDescriptor&gt; to identify one
                                    or more EntityDescriptors to add all the preceding extension elements to. 
                                </documentation>
                            </annotation>
                        </element>
                    </choice>
                </sequence>
            </extension>
        </complexContent>
    </complexType>
    
    <complexType name="NodeProcessing">
        <annotation>
            <documentation>
                A metadata filter that applies a sequence of node processor plugins to the tree.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <sequence>
                    <element ref="shibmd:MetadataNodeProcessor" minOccurs="0" maxOccurs="unbounded">
                        <annotation>
                            <documentation>A node processor to be applied.</documentation>
                        </annotation>
                    </element>
                </sequence>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="ByReference">
        <annotation>
            <documentation>
                A metadata filter that associates filters declared "out of band" with specific
                MetadataProvider instances.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataFilterType">
                <sequence>
                    <element name="MetadataFilters" minOccurs="0" maxOccurs="unbounded">
                        <annotation>
                            <documentation>A set of filters applied to a specific provider by name.</documentation>
                        </annotation>
                        <complexType>
                            <sequence>
                                <element ref="shibmd:MetadataFilter" minOccurs="0" maxOccurs="unbounded" />
                            </sequence>
                            <attribute name="providerRef" type="shibmd:string" use="required" />
                        </complexType>
                    </element>
                </sequence>
            </extension>
        </complexContent>
    </complexType>

    <complexType name="MetadataFilterType" abstract="true"/>
    
    <element name="MetadataNodeProcessor" type="shibmd:MetadataNodeProcessorType">
        <annotation>
            <documentation>
                Defines a plugin that walks the tree of objects in an unmarshalled metadata instance.
            </documentation>
        </annotation>
    </element>
    
    <complexType name="EntitiesDescriptorName">
        <annotation>
            <documentation>
                A node processor that attaches Name information from enclosing EntitiesDescriptors to
                an entity via an extension object, to maintain group information while flattening the tree.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataNodeProcessorType"/>
        </complexContent>
    </complexType>

    <complexType name="KeyAuthority">
        <annotation>
            <documentation>
                A node processor that processes KeyAuthority extensions and attaches the parsed PKIX
                information via an extension object.
            </documentation>
        </annotation>
        <complexContent>
            <extension base="shibmd:MetadataNodeProcessorType"/>
        </complexContent>
    </complexType>
    
    <complexType name="MetadataNodeProcessorType" abstract="true"/>
    
    <complexType name="ScriptType">
        <annotation>
            <documentation>
                A type for elements that allow for scripts to be declared inline or via a resource.
            </documentation>
        </annotation>
        <choice>
            <element name="Script" type="shibmd:string">
                <annotation>
                    <documentation>The script to evaluate to construct the attribute.</documentation>
                </annotation>
            </element>
            <element name="ScriptFile" type="shibmd:string">
                <annotation>
                    <documentation>
                        Path of a local resource containing the script to evaluate to construct the attribute.
                    </documentation>
                </annotation>
            </element>
        </choice>
        <attribute name="language" type="shibmd:string">
            <annotation>
                <documentation>
                    The JSR-233 name for the scripting language that will be used.
                    By default "javascript" is assumed.
                </documentation>
            </annotation>
        </attribute>
        <attribute name="customObjectRef" type="shibmd:string">
            <annotation>
                <documentation>
                    The name of a bean defined somewhere else which will be injected into the script as an
                    object called "custom". If not supplied, nothing is injected.
                </documentation>
            </annotation>
        </attribute>
    </complexType>

    <simpleType name="string">
        <restriction base="string">
            <minLength value="1"/>
        </restriction>
    </simpleType>
</schema>
